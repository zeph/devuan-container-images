# SPDX-License-Identifier: CC-BY-SA-4.0
# SPDX-FileCopyrightText: Â© 2022 Olaf Meeuwissen

# Note: Path names are relative to the project's top-level directory.

migrate:
  stage: build
  image: docker:cli
  services:
    - docker:dind
  before_script:
    - docker version
  script:
    - docker build
          --build-arg DEBIAN_CODENAME
          --build-arg DEVUAN_CODENAME
          --build-arg IMAGE_VARIANT
          --tag $MIGRATED_TAG
          migrated
    - TIMESTAMP=$(date -u +%F)
    - docker tag $MIGRATED_TAG $MIGRATED_TAG-$TIMESTAMP
    - docker push --quiet      $MIGRATED_TAG-$TIMESTAMP
    - docker push --quiet      $MIGRATED_TAG
    - docker tag $MIGRATED_TAG $IMAGE_BASE:$DEVUAN_SUITE$IMAGE_VARIANT
    - docker push --quiet      $IMAGE_BASE:$DEVUAN_SUITE$IMAGE_VARIANT
    - |
      : ${IMAGE_VARIANT:=latest}
      if test "$DEVUAN_SUITE" = "stable"; then
          docker tag $MIGRATED_TAG $IMAGE_BASE:${IMAGE_VARIANT#-}
          docker push --quiet      $IMAGE_BASE:${IMAGE_VARIANT#-}
      fi
  variables:
    DEBIAN_CODENAME: bullseye
    DEVUAN_CODENAME: chimaera
    DEVUAN_SUITE: stable
    IMAGE_VARIANT: -slim
    CONTAINER_REGISTRY: $CI_REGISTRY_IMAGE
    IMAGE_BASE: $CONTAINER_REGISTRY/devuan/migrated
    MIGRATED_TAG: $IMAGE_BASE:$DEVUAN_CODENAME$IMAGE_VARIANT
  rules:
    - changes:
        - .gitlab-ci.yaml
        - migrated/**/*
